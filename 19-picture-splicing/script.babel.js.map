{"version":3,"sources":["script.js"],"names":["Puzzle","_images","val","_imageIndex","_changeBackgroundImage","elem","width","height","images","piecesNum","levels","id","parseInt","Math","random","toString","dataset","style","position","top","left","opacity","$backgroundImage","document","createElement","head","append","maxOffsetX","maxOffsetY","_preload","cx","cy","$style","innerText","_compressCss","pieces","i","piece","translateX","translateY","_setPieceStyle","isClicked","addEventListener","classList","add","animatedCount","contains","imageIndex","length","reset","requestAnimationFrame","remove","offsetXRatio","offsetYRatio","forEach","zIndex","transform","bind","floor","sizeRandom","radiusRandom","rad","PI","cos","sin","backgroundPosition","animationDelay","css","replace","match","trim","loadedCount","onLoad","transition","ontransitionend","removeEventListener","image","img","src","size","min","window","innerWidth","innerHeight","puzzle","querySelector","Date","now","init","e","parallax","clientX","clientY"],"mappings":"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","sourcesContent":["class Puzzle {\r\n    pieces = []; // 所有碎片\r\n\r\n    _images = [];\r\n    get images() {\r\n        return this._images;\r\n    }\r\n    set images(val) {\r\n        this._images = val;\r\n        this._imageIndex = 0;\r\n        this._changeBackgroundImage();\r\n    }\r\n\r\n    _imageIndex = 0;\r\n    get imageIndex() {\r\n        return this._imageIndex;\r\n    }\r\n    set imageIndex(val) {\r\n        this._imageIndex = val;\r\n        this._changeBackgroundImage();\r\n    }\r\n\r\n    constructor(elem, width, height, images = [], piecesNum = 160, levels = 8) {\r\n        this.elem = elem;\r\n        const id = (this.id = parseInt(Math.random() * (0xffffffff - 0xfffffff) + 0xfffffff).toString(16));\r\n        elem.dataset[id] = '';\r\n        elem.style.position = 'relative';\r\n        elem.style.top = '0';\r\n        elem.style.left = '0';\r\n        elem.style.opacity = '0';\r\n\r\n        this.$backgroundImage = document.createElement('style');\r\n        document.head.append(this.$backgroundImage);\r\n\r\n        this.width = width;\r\n        this.maxOffsetX = width / 20;\r\n        this.height = height;\r\n        this.maxOffsetY = height / 20;\r\n\r\n        this.images = images;\r\n        this._preload();\r\n\r\n        this.piecesNum = piecesNum;\r\n        this.levels = levels;\r\n\r\n        this.cx = width / 2;\r\n        this.cy = height / 2;\r\n\r\n        const $style = document.createElement('style');\r\n        $style.innerText = this._compressCss(`\r\n            [data-${id}] > * {\r\n                background-size: ${width}px ${height}px;\r\n                background-repeat: no-repeat;\r\n                position: absolute;\r\n                box-shadow: 0 0 20px 6px rgba(0, 0, 0, 0.4);\r\n            }\r\n            [data-${id}].in > * {\r\n                animation: in-${id} 0.3s ease-out backwards;\r\n            }\r\n            [data-${id}].out > * {\r\n                animation: out-${id} 0.3s ease-out forwards;\r\n            }\r\n            @keyframes in-${id} {\r\n                from {\r\n                    opacity: 0;\r\n                    transform: translate3d(${-width}px, 0, 0) scale(1, 0);\r\n                }\r\n            }\r\n            @keyframes out-${id} {\r\n                to {\r\n                    opacity: 0;\r\n                    transform: translate3d(${width}px, 0, 0) scale(1, 0);\r\n                }\r\n            }\r\n        `);\r\n        document.head.append($style);\r\n    }\r\n\r\n    init() {\r\n        const { elem, pieces, piecesNum, images } = this;\r\n\r\n        for (let i = 0; i < piecesNum; i++) {\r\n            const piece = (pieces[i] = {\r\n                translateX: 0,\r\n                translateY: 0,\r\n            });\r\n            piece.elem = document.createElement('div');\r\n            this._setPieceStyle(piece, i);\r\n            elem.append(piece.elem);\r\n        }\r\n\r\n        let isClicked = false;\r\n        elem.addEventListener('click', () => {\r\n            if (!isClicked) {\r\n                isClicked = true;\r\n                elem.classList.add('out');\r\n            }\r\n        });\r\n        let animatedCount = 0;\r\n        elem.addEventListener('animationend', () => {\r\n            animatedCount++;\r\n            if (animatedCount === piecesNum) {\r\n                animatedCount = 0;\r\n                if (elem.classList.contains('out')) {\r\n                    this.imageIndex = (this.imageIndex + 1) % images.length;\r\n                    this.reset();\r\n                    requestAnimationFrame(() => {\r\n                        elem.classList.remove('out');\r\n                        elem.classList.add('in');\r\n                    });\r\n                } else if (elem.classList.contains('in')) {\r\n                    elem.classList.remove('in');\r\n                    isClicked = false;\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n    parallax(offsetXRatio, offsetYRatio) {\r\n        const { maxOffsetX, maxOffsetY, levels, piecesNum } = this;\r\n        this.pieces.forEach((piece, i) => {\r\n            piece.translateX = offsetXRatio * maxOffsetX * (piece.zIndex / levels + i / piecesNum); // 层级越高、索引越大，偏移量越大\r\n            piece.translateY = offsetYRatio * maxOffsetY * (piece.zIndex / levels + i / piecesNum);\r\n            piece.elem.style.transform = `translate3d(${piece.translateX}px,${piece.translateY}px,0)`;\r\n        });\r\n    }\r\n\r\n    reset() {\r\n        this.pieces.forEach(this._setPieceStyle.bind(this));\r\n    }\r\n\r\n    _changeBackgroundImage() {\r\n        this.$backgroundImage.innerText = this._compressCss(`\r\n            [data-${this.id}] > * {\r\n                background-image: url(${this.images[this.imageIndex]});\r\n            }\r\n        `);\r\n    }\r\n\r\n    _setPieceStyle(piece, i) {\r\n        const { cx, cy, levels, piecesNum } = this;\r\n\r\n        const style = piece.elem.style;\r\n\r\n        const zIndex = (piece.zIndex = style.zIndex = Math.floor((i / piecesNum) ** (1 / 3) * levels + 1)); // 非均匀分布，层级越高，碎片数量越多\r\n\r\n        const sizeRandom = Math.random();\r\n        const width = (piece.width = cx * ((sizeRandom + levels - zIndex) / levels)); // 层级越高，尺寸越小\r\n        const height = (piece.height = cy * ((sizeRandom + levels - zIndex) / levels));\r\n        style.width = width + 'px';\r\n        style.height = height + 'px';\r\n\r\n        const radiusRandom = Math.random();\r\n        const rad = Math.random() * Math.PI * 2; // 随机的角度，碎片将分布在容器的内切椭圆中\r\n        const left = (piece.left = cx * ((radiusRandom + zIndex - 1) / levels) * Math.cos(rad) - width / 2); // 层级越高，距离中心越远\r\n        const top = (piece.top = cy * ((radiusRandom + zIndex - 1) / levels) * Math.sin(rad) - height / 2);\r\n        style.left = left + 'px';\r\n        style.top = top + 'px';\r\n        style.backgroundPosition = `${-left - cx}px ${-top - cy}px`;\r\n        style.animationDelay = (Math.random() + i / piecesNum) * 0.5 + 's';\r\n    }\r\n\r\n    _compressCss(css) {\r\n        return css\r\n            .replace(/\\s{2,}/, ' ')\r\n            .replace(/\\s*[{};,>~=-]\\s*|[(\\[:]\\s*|\\s*[)\\]]/g, match => match.trim())\r\n            .trim();\r\n    }\r\n\r\n    _preload() {\r\n        let loadedCount = 0;\r\n        const onLoad = function () {\r\n            loadedCount++;\r\n            if (loadedCount === this.images.length) {\r\n                this.elem.style.transition = 'opacity 0.2s linear';\r\n                this.elem.style.opacity = '1';\r\n                this.elem.addEventListener('transitionend', function ontransitionend() {\r\n                    this.style.transition = '';\r\n                    this.style.opacity = '';\r\n                    this.removeEventListener('transitionend', ontransitionend);\r\n                });\r\n            }\r\n        };\r\n        this.images.forEach(image => {\r\n            const img = document.createElement('img');\r\n            img.src = image;\r\n            img.addEventListener('load', onLoad.bind(this));\r\n        });\r\n    }\r\n}\r\n\r\nconst size = Math.min(window.innerWidth, window.innerHeight);\r\nconst puzzle = new Puzzle(document.querySelector('.box'), size, size, [\r\n    './img/bg1.jpg',\r\n    './img/bg2.jpg',\r\n    './img/bg3.jpg',\r\n]);\r\npuzzle.imageIndex = Date.now() % 3;\r\npuzzle.init();\r\n\r\nwindow.addEventListener('mousemove', function (e) {\r\n    puzzle.parallax(1 - (2 * e.clientX) / window.innerWidth, 1 - (2 * e.clientY) / window.innerHeight);\r\n});\r\n"],"file":"script.babel.js"}